{% extends "base.html" %}

{% block title %}Settings - FastRep{% endblock %}

{% block content %}
<div class="settings-page">
    <div class="card">
        <h2>‚öôÔ∏è Settings</h2>

        <div class="settings-section">
            <h3>Appearance</h3>
            <p class="info-text">
                Choose your preferred theme.
            </p>
            <div class="theme-toggle">
                <button onclick="setTheme('light')" class="btn btn-secondary">‚òÄÔ∏è Light</button>
                <button onclick="setTheme('dark')" class="btn btn-secondary">üåô Dark</button>
                <button onclick="setTheme('system')" class="btn btn-secondary">üíª System</button>
            </div>
            <p id="current-theme-text" class="info-text">Current theme: System</p>
        </div>

        <div class="settings-section">
            <h3>AI Summarization</h3>
            <p class="info-text">
                Automatically summarize project logs in monthly reports using Cline CLI.
            </p>
            
            <div id="ai-status" class="status-indicator">
                Checking availability...
            </div>
            
            <div class="toggle-container" style="margin-top: 1rem; display: block;">
                <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Enable Summarization for:</label>
                <div style="display: flex; gap: 1.5rem; flex-wrap: wrap;">
                    <div class="toggle-container">
                        <label class="switch">
                            <input type="checkbox" id="ai-weekly" onchange="updateAiSettings()">
                            <span class="slider round"></span>
                        </label>
                        <span>Weekly</span>
                    </div>
                    <div class="toggle-container">
                        <label class="switch">
                            <input type="checkbox" id="ai-biweekly" onchange="updateAiSettings()">
                            <span class="slider round"></span>
                        </label>
                        <span>Bi-weekly</span>
                    </div>
                    <div class="toggle-container">
                        <label class="switch">
                            <input type="checkbox" id="ai-monthly" onchange="updateAiSettings()">
                            <span class="slider round"></span>
                        </label>
                        <span>Monthly</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 1rem;">
                <label for="ai-points">Number of Summary Points</label>
                <input type="text" id="ai-points" placeholder="e.g. 3-5" onchange="updateAiSettings()" style="width: 200px;">
                <p class="info-text" style="margin-top: 0.25rem;">Specify a range (e.g. "3-5") or a fixed number (e.g. "5").</p>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label for="ai-timeout">Timeout (seconds)</label>
                <input type="number" id="ai-timeout" placeholder="120" onchange="updateAiSettings()" style="width: 200px;">
                <p class="info-text" style="margin-top: 0.25rem;">Maximum time to wait for AI response per project.</p>
            </div>

            <div class="form-group" style="margin-top: 1rem;">
                <label for="ai-instructions">Custom AI Instructions</label>
                <textarea id="ai-instructions" rows="3" onchange="updateAiSettings()" placeholder="E.g. 'Focus on technical details', 'Use bullet points only', etc."></textarea>
                <p class="info-text" style="margin-top: 0.25rem;">Additional instructions for the final report improvement step.</p>
            </div>

            <div class="form-group" style="margin-top: 1rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
                <label for="ai-provider">AI Provider</label>
                <select id="ai-provider" onchange="updateAiSettings(); toggleProviderFields();" style="width: 200px; padding: 0.5rem;">
                    <option value="openai">OpenAI</option>
                    <option value="anthropic">Anthropic</option>
                    <option value="gemini">Google Gemini</option>
                    <option value="custom">Custom (OpenAI Compatible)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="ai-api-key">API Key</label>
                <input type="password" id="ai-api-key" onchange="updateAiSettings()" style="width: 100%;">
            </div>

            <div class="form-group">
                <label for="ai-model">Model Name (Optional)</label>
                <input type="text" id="ai-model" placeholder="Default" onchange="updateAiSettings()" style="width: 100%;">
            </div>

            <div class="form-group" id="base-url-group" style="display:none;">
                <label for="ai-base-url">Base URL (For Custom)</label>
                <input type="text" id="ai-base-url" placeholder="http://localhost:11434/v1" onchange="updateAiSettings()" style="width: 100%;">
            </div>
        </div>

        <div class="settings-section">
            <h3>Report Template</h3>
            <p class="info-text">Choose a formatting style for your reports.</p>
            
            <div class="template-selector">
                <div class="form-group">
                    <label>Select Template:</label>
                    <select id="report-template" onchange="updateTemplatePreview()" style="width: 200px; padding: 0.5rem;">
                        <option value="classic">Classic</option>
                        <option value="classic_clean">Classic (No Header)</option>
                        <option value="bold">Bold Dates</option>
                        <option value="modern">Modern</option>
                        <option value="professional">Professional</option>
                        <option value="professional_clean">Professional (No Header)</option>
                        <option value="compact">Compact</option>
                    </select>
                </div>
                
                <div class="template-preview-box">
                    <h4>Preview</h4>
                    <div id="template-preview-content" class="report-content" style="margin: 0; border: 1px solid var(--border-color); padding: 1rem; border-radius: 4px; background: var(--background); white-space: normal;">
                        <!-- Preview content injected by JS -->
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-section">
            <h3>Preferences</h3>
            
            <div class="form-group">
                <label for="recent-limit">Recent Logs Limit</label>
                <input type="number" id="recent-limit" placeholder="20" onchange="updatePreferences()" style="width: 200px;">
                <p class="info-text" style="margin-top: 0.25rem;">Number of recent logs to display on dashboard.</p>
            </div>
            
            <div class="toggle-container">
                <label class="switch">
                    <input type="checkbox" id="auto-browser" onchange="updatePreferences()">
                    <span class="slider round"></span>
                </label>
                <span>Auto-open Browser on Startup</span>
            </div>
        </div>
        
        
        <div class="settings-section">
            <h3>Database Management</h3>
            <p class="info-text">
                ‚ö†Ô∏è Warning: Clearing the database will permanently delete all log entries. This action cannot be undone.
            </p>
            
            <button onclick="clearDatabase()" class="btn btn-danger">Clear All Data</button>
        </div>
        
        <div class="settings-section">
            <h3>Database Location</h3>
            <p class="info-text">
                Your logs are stored in: <code>~/.fastrep/fastrep.db</code>
            </p>
        </div>
        
        <div class="settings-section">
            <h3>CLI Access</h3>
            <p class="info-text">
                You can also manage your logs using the command line:
            </p>
            <pre><code>fastrep log -p "Project Name" -d "Description"
fastrep view --mode weekly
fastrep list
fastrep delete --id 1</code></pre>
        </div>
        
        <div class="settings-section">
            <h3>About</h3>
            <p class="info-text">
                FastRep v2.0.8<br>
                A simple work log manager for tracking daily activities and generating reports.<br>
                <a href="https://github.com/hissain/fastrep" target="_blank">GitHub Repository</a>
            </p>
        </div>
    </div>
    
    <div class="card">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">‚Üê Back to Home</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Theme settings
function updateThemeText() {
    const theme = localStorage.getItem('theme') || 'system';
    const text = theme.charAt(0).toUpperCase() + theme.slice(1);
    document.getElementById('current-theme-text').textContent = `Current theme: ${text}`;
}

function setTheme(theme) {
    if (theme === 'system') {
        localStorage.removeItem('theme');
        delete document.documentElement.dataset.theme;
        // Re-apply system preference check if needed, but removing dataset.theme usually falls back to default CSS
        // However, if we want to support system preference in CSS, we need media queries or JS detection.
        // My CSS uses [data-theme="dark"], so removing it reverts to light.
        // To support system dark mode properly, I should check window.matchMedia.
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
             document.documentElement.dataset.theme = 'dark';
        }
    } else {
        localStorage.setItem('theme', theme);
        document.documentElement.dataset.theme = theme;
    }
    updateThemeText();
}

// Initialize text
updateThemeText();

// Toggle provider fields
function toggleProviderFields() {
    const provider = document.getElementById('ai-provider').value;
    const baseUrlGroup = document.getElementById('base-url-group');
    if (provider === 'custom') {
        baseUrlGroup.style.display = 'block';
    } else {
        baseUrlGroup.style.display = 'none';
    }
}

// AI Settings
async function loadAiSettings() {
    try {
        const response = await fetch('/api/settings');
        const settings = await response.json();
        
        const statusDiv = document.getElementById('ai-status');
        const toggle = document.getElementById('ai-toggle'); // Note: this ID is no longer used for main toggle, but kept if needed
        
        if (settings.cline_available) {
            statusDiv.innerHTML = '‚úÖ Cline CLI detected';
            statusDiv.className = 'status-indicator success';
        } else {
            statusDiv.innerHTML = '‚ùå Cline CLI not found';
            statusDiv.className = 'status-indicator error';
        }
        
        document.getElementById('ai-weekly').checked = settings.ai_summary_weekly;
        document.getElementById('ai-biweekly').checked = settings.ai_summary_biweekly;
        document.getElementById('ai-monthly').checked = settings.ai_summary_monthly;
        
        if (settings.ai_summary_points) {
            document.getElementById('ai-points').value = settings.ai_summary_points;
        }
        if (settings.ai_timeout) {
            document.getElementById('ai-timeout').value = settings.ai_timeout;
        }
        if (settings.ai_custom_instructions) {
            document.getElementById('ai-instructions').value = settings.ai_custom_instructions;
        }
        
        if (settings.ai_provider) document.getElementById('ai-provider').value = settings.ai_provider;
        if (settings.ai_api_key) document.getElementById('ai-api-key').value = settings.ai_api_key;
        if (settings.ai_model) document.getElementById('ai-model').value = settings.ai_model;
        if (settings.ai_base_url) document.getElementById('ai-base-url').value = settings.ai_base_url;
        
        toggleProviderFields();
        
        // Templates
        if (settings.report_template) {
            document.getElementById('report-template').value = settings.report_template;
        }
        updateTemplatePreview();
        
        // Preferences
        if (settings.recent_logs_limit) {
            document.getElementById('recent-limit').value = settings.recent_logs_limit;
        }
        document.getElementById('auto-browser').checked = settings.auto_open_browser;

    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

async function updatePreferences() {
    const limit = document.getElementById('recent-limit').value;
    const autoBrowser = document.getElementById('auto-browser').checked;
    
    try {
        await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                recent_logs_limit: limit,
                auto_open_browser: autoBrowser
            })
        });
    } catch (error) {
        console.error('Error updating preferences:', error);
    }
}

async function updateAiSettings() {
    const weekly = document.getElementById('ai-weekly').checked;
    const biweekly = document.getElementById('ai-biweekly').checked;
    const monthly = document.getElementById('ai-monthly').checked;
    
    const points = document.getElementById('ai-points').value;
    const timeout = document.getElementById('ai-timeout').value;
    const instructions = document.getElementById('ai-instructions').value;
    
    const provider = document.getElementById('ai-provider').value;
    const apiKey = document.getElementById('ai-api-key').value;
    const model = document.getElementById('ai-model').value;
    const baseUrl = document.getElementById('ai-base-url').value;
    
    try {
        await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                ai_summary_weekly: weekly,
                ai_summary_biweekly: biweekly,
                ai_summary_monthly: monthly,
                ai_summary_points: points,
                ai_timeout: timeout,
                ai_custom_instructions: instructions,
                ai_provider: provider,
                ai_api_key: apiKey,
                ai_model: model,
                ai_base_url: baseUrl
            })
        });
    } catch (error) {
        console.error('Error updating settings:', error);
    }
}

function updateTemplatePreview() {
    const template = document.getElementById('report-template').value;
    const previewDiv = document.getElementById('template-preview-content');
    
    // Mock Data
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const formatDate = (d, type) => {
        if (type === 'full') return d.toISOString().split('T')[0];
        if (type === 'long') return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        if (type === 'short') return d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
        return d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit' });
    };
    
    const header = template.includes('clean') || template === 'compact' ? '' : `<p><strong>Report Period:</strong> ${formatDate(yesterday, 'short')} - ${formatDate(today, 'short')}</p>`;
    
    let itemFormat = (d, desc) => `<li><strong>${d}</strong> - ${desc}</li>`;
    let dateFormat = 'short';
    
    if (template.startsWith('bold')) {
        dateFormat = 'full';
        itemFormat = (d, desc) => `<li><b style="color:var(--primary-color)">${d}</b>: ${desc}</li>`;
    } else if (template.startsWith('modern')) {
        dateFormat = 'long';
        itemFormat = (d, desc) => `<li>${desc} <em style="color:var(--text-secondary)">(${d})</em></li>`;
    } else if (template.startsWith('professional')) {
        dateFormat = 'long';
        itemFormat = (d, desc) => `<li><span class="badge" style="background:#64748b">${d}</span> ${desc}</li>`;
    } else if (template === 'compact') {
        dateFormat = 'short';
        itemFormat = (d, desc) => `<li><small style="color:var(--text-secondary)">${d}</small> ${desc}</li>`;
    }
    
    const renderProject = (name, tasks) => `
        <h4>${name}</h4>
        <ul>
            ${tasks.map(t => itemFormat(formatDate(t.date, dateFormat), t.desc)).join('')}
        </ul>
    `;
    
    let html = header;
    html += renderProject('Project Alpha', [
        {date: today, desc: 'Implemented new authentication flow'},
        {date: yesterday, desc: 'Fixed login bug reported by QA'}
    ]);
    html += renderProject('Maintenance', [
        {date: today, desc: 'Server updates and security patches'}
    ]);
    
    previewDiv.innerHTML = html;
    
    // Save setting
    fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ report_template: template })
    }).catch(err => console.error(err));
}

// Load settings on page load
loadAiSettings();

async function clearDatabase() {
    const confirmed = confirm(
        '‚ö†Ô∏è Are you absolutely sure you want to delete ALL log entries?\n\n' +
        'This action cannot be undone!'
    );
    
    if (!confirmed) {
        return;
    }
    
    const doubleCheck = confirm(
        'This is your last chance!\n\n' +
        'Click OK to permanently delete all data.'
    );
    
    if (!doubleCheck) {
        return;
    }
    
    try {
        const response = await fetch('/clear_all', {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úì All data has been cleared successfully.');
            window.location.href = '/';
        } else {
            alert('‚úó Error clearing database');
        }
    } catch (error) {
        alert('‚úó Error clearing database');
    }
}
</script>
{% endblock %}
